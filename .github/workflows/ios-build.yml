name: Build iOS App

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios_app/**'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios_app/**'
  workflow_dispatch:  # Manual trigger

jobs:
  build-ios:
    runs-on: macos-14  # Apple Silicon for faster builds
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Flutter version info
      run: flutter --version
      
    - name: Flutter dependencies
      working-directory: ios_app
      run: flutter pub get
      
    - name: Create iOS project files
      working-directory: ios_app
      run: |
        # Generate the native iOS project structure
        flutter create --platforms=ios .
        
        # Show what was created
        ls -la ios/
        
    - name: Install xcodeproj gem
      run: |
        gem install xcodeproj
        
    - name: Copy widget Swift files to generated project
      working-directory: ios_app
      run: |
        # Ensure BusWidget folder exists in ios/
        mkdir -p ios/BusWidget
        
        # Copy our Swift widget files
        if [ -f "ios/BusWidget/BusWidget.swift" ]; then
          echo "Widget Swift files already in place"
        else
          echo "Widget Swift files should be in ios/BusWidget/"
        fi
        
        ls -la ios/BusWidget/ || echo "BusWidget folder empty or missing"
        
    - name: Setup widget extension (automated)
      working-directory: ios_app
      run: |
        # Run our automated Xcode project configuration
        ruby scripts/setup_widget_extension.rb
        
    - name: Build iOS (unsigned)
      working-directory: ios_app
      run: |
        flutter build ios --release --no-codesign
        
    - name: Create IPA archive
      working-directory: ios_app
      run: |
        # Create the Payload directory structure
        mkdir -p Payload
        
        # Copy the .app bundle
        cp -r build/ios/iphoneos/Runner.app Payload/
        
        # Check if widget extension was built
        if [ -d "build/ios/iphoneos/BusWidget.appex" ]; then
          echo "‚úì Widget extension was built"
          cp -r build/ios/iphoneos/BusWidget.appex Payload/Runner.app/PlugIns/
        else
          echo "‚ö† Widget extension not found in build output"
        fi
        
        # Create the IPA (which is just a ZIP file)
        zip -r OASTH-Live.ipa Payload
        
        # Cleanup
        rm -rf Payload
        
        # Show result
        ls -la OASTH-Live.ipa
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: oasth-live-ios
        path: ios_app/OASTH-Live.ipa
        retention-days: 30
        
  # Release job (only on tagged releases)
  release:
    needs: build-ios
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download IPA
      uses: actions/download-artifact@v4
      with:
        name: oasth-live-ios
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: OASTH-Live.ipa
        name: "OASTH Live iOS ${{ github.ref_name }}"
        body: |
          ## iOS Release
          
          Download `OASTH-Live.ipa` and sideload with:
          - [AltStore/AltServer](https://altstore.io/)
          - [Sideloadly](https://sideloadly.io/)
          - [AltLinux](https://github.com/NyaMisty/AltLinux) (for Linux)
          
          **Features:**
          - üì± Two widget variants: Standard & Compact
          - üé® LED-style display matching Android
          - üî¥üü¢ Urgency colors (Compact widget)
          - üîç Line filtering
          
          **Note:** Free Apple ID requires re-signing every 7 days.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
